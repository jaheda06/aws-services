#!/bin/bash

# Variables
INSTANCE_ID="i-0fafd17037f71ddco"  
ALARM_NAME="High-Network-In-Alarm"
SNS_TOPIC_NAME="NetworkLoadAlerts"
EMAIL_ADDRESS="jahedashaik73@gmail.com" 
SQS_QUEUE_NAME="MyQueue"
REGION="ap-south-1" 

# Create an SNS Topic
echo "Creating SNS topic: $SNS_TOPIC_NAME"
SNS_TOPIC_ARN=$(aws sns create-topic --name "$SNS_TOPIC_NAME" --region "$REGION" --query 'TopicArn' --output text)
echo "SNS topic ARN: $SNS_TOPIC_ARN"

# Subscribe email to SNS Topic
echo "Subscribing $EMAIL_ADDRESS to SNS topic: $SNS_TOPIC_NAME"
aws sns subscribe --topic-arn "$SNS_TOPIC_ARN" --protocol email --notification-endpoint "$EMAIL_ADDRESS" --region "$REGION"

# Create an SQS Queue
echo "Creating SQS queue: $SQS_QUEUE_NAME"
SQS_QUEUE_URL=$(aws sqs create-queue --queue-name "$SQS_QUEUE_NAME" --region "$REGION" --query 'QueueUrl' --output text)
echo "SQS queue URL: $SQS_QUEUE_URL"

# Get the SQS Queue ARN
SQS_QUEUE_ARN=$(aws sqs get-queue-attributes --queue-url "$SQS_QUEUE_URL" --attribute-names QueueArn --region "$REGION" --query 'Attributes.QueueArn' --output text)
echo "SQS queue ARN: $SQS_QUEUE_ARN"

# Subscribe the SQS queue to the SNS topic
echo "Subscribing SQS queue to SNS topic"
aws sns subscribe --topic-arn "$SNS_TOPIC_ARN" --protocol sqs --notification-endpoint "$SQS_QUEUE_ARN" --region "$REGION"

# Create a CloudWatch Alarm for NetworkIn metric
echo "Creating CloudWatch alarm: $ALARM_NAME"
aws cloudwatch put-metric-alarm --alarm-name "$ALARM_NAME" \
    --metric-name NetworkIn --namespace AWS/EC2 \
    --statistic Average --period 300 --threshold 10000000 \
    --comparison-operator GreaterThanThreshold --evaluation-periods 1 \
    --alarm-actions "$SNS_TOPIC_ARN" --dimensions Name=InstanceId,Value="$INSTANCE_ID" \
    --region "$REGION"

echo "CloudWatch alarm created: $ALARM_NAME"

# Verify messages being sent to the SQS queue (Optional: Polling for messages)
echo "Verifying messages in SQS queue: $SQS_QUEUE_NAME"
aws sqs receive-message --queue-url "$SQS_QUEUE_URL" --max-number-of-messages 10 --wait-time-seconds 10 --region "$REGION"

echo "Setup completed. Check your email for SNS notifications and verify SQS queue for messages."
